{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="auth-body">
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="bg-layer layer-1"></div>
        <div class="bg-layer layer-2"></div>
        <div class="bg-layer layer-3"></div>
    </div>
    
    <!-- Particle System -->
    <canvas id="particles-canvas" class="particles-canvas"></canvas>
    
    <!-- Main Content -->
    <main class="auth-main">
        <div class="auth-container" style="max-width: 1200px; grid-template-columns: 1fr;">
            <div class="auth-form-section">
                <div class="auth-form-container">
                    <div class="auth-header">
                        <h1 class="auth-title">College Search</h1>
                        <p class="auth-subtitle">Find matching colleges by percentile, category, courses, and locations</p>
                    </div>
                    
                    <!-- Search Form -->
                    <form id="collegeSearchForm" class="auth-form" method="POST">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="percentile" class="form-label">
                                    <svg class="label-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    Percentile
                                </label>
                                <input type="number" id="percentile" name="percentile" class="form-input" min="0" max="100" step="0.01" placeholder="Enter your percentile" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="category" class="form-label">
                                    <svg class="label-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    Category
                                </label>
                                <select id="category" name="category" class="form-select" required>
                                    <option value="">Select Category</option>
                                    <option value="General">General</option>
                                    <option value="OBC">OBC</option>
                                    <option value="SC">SC</option>
                                    <option value="ST">ST</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="course" class="form-label">
                                <svg class="label-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Courses
                            </label>
                            <div class="select-all-container">
                                <button type="button" id="selectAllCourses" class="select-all-btn">Select All Courses</button>
                                <button type="button" id="clearAllCourses" class="clear-all-btn">Clear All</button>
                            </div>
                            <select id="course" name="course" class="form-select" multiple>
                                <!-- Courses will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="cities" class="form-label">
                                <svg class="label-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Cities
                            </label>
                            <div class="select-all-container">
                                <button type="button" id="selectAllCities" class="select-all-btn">Select All Cities</button>
                                <button type="button" id="clearAllCities" class="clear-all-btn">Clear All</button>
                            </div>
                            <select id="cities" name="cities" class="form-select" multiple>
                                <!-- Cities will be populated dynamically -->
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-xl" id="searchBtn">
                            <span class="btn-text">Search Colleges</span>
                            <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </form>
                    
                    <!-- Results Section -->
                    <div id="resultsSection" class="results-section" style="display: none; margin-top: 2rem;">
                        <h2 class="section-title">Matching Colleges</h2>
                        <div id="resultsContainer" class="results-container">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" class="loading-indicator" style="display: none; text-align: center; margin: 2rem 0;">
                        <div class="spinner"></div>
                        <p>Searching colleges...</p>
                    </div>
                    
                    <!-- No Results Message -->
                    <div id="noResultsMessage" class="no-results" style="display: none; text-align: center; margin: 2rem 0; padding: 2rem; background: var(--bg-glass); border-radius: var(--radius-lg);">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" style="margin-bottom: 1rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3>No Matching Colleges Found</h3>
                        <p>Try adjusting your search criteria to find more results.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Custom Styles for College Search -->
<style>
    /* Profile image sizing fix */
    .profile-btn img {
        width: 36px;
        height: 36px;
        object-fit: cover;
        border-radius: 50%;
    }
    
    /* Ensure all images and SVGs have proper sizing */
    img, svg {
        max-width: 100%;
        height: auto;
    }
    
    /* Specific sizing for label icons */
    .label-icon {
        width: 16px;
        height: 16px;
        vertical-align: middle;
        margin-right: 0.5rem;
        flex-shrink: 0;
    }
    
    /* Specific sizing for button icons */
    .btn-icon {
        width: 20px;
        height: 20px;
        vertical-align: middle;
        margin-left: 0.5rem;
        flex-shrink: 0;
    }
    
    /* Select All / Clear All buttons container */
    .select-all-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }
    
    /* Select All / Clear All buttons */
    .select-all-btn,
    .clear-all-btn {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border-radius: 8px;
        border: 1px solid var(--border-primary);
        background: var(--bg-glass);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 120px;
        text-align: center;
    }
    
    .select-all-btn:hover,
    .clear-all-btn:hover {
        background: var(--gradient-primary);
        color: white;
        border-color: var(--primary-500);
    }
    
    /* Improved multi-select styling */
    .form-select[multiple] {
        height: 200px;
        padding: 0.5rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
        overflow-y: auto;
    }
    
    .form-select[multiple]:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
    }
    
    .form-select[multiple] option {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin: 2px 0;
    }
    
    .form-select[multiple] option:checked {
        background: var(--gradient-primary);
        color: white;
    }
    
    /* Table Container with Horizontal Scrolling */
    .table-container {
        overflow-x: auto;
        border-radius: var(--radius-lg);
        margin-top: 1rem;
        box-shadow: var(--shadow-lg);
        background: var(--bg-glass);
        border: 1px solid var(--border-primary);
    }
    
    /* Results Table */
    .results-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px; /* Ensure table has minimum width */
        background: var(--bg-glass);
    }
    
    .results-table th {
        background: var(--gradient-primary);
        color: white;
        text-align: left;
        padding: 1rem;
        font-weight: 600;
        position: sticky;
        top: 0;
    }
    
    .results-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-primary);
        color: var(--text-secondary);
    }
    
    .results-table tr:last-child td {
        border-bottom: none;
    }
    
    .results-table tr:hover {
        background: var(--bg-glass-hover);
    }
    
    /* Cards Layout */
    .results-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .result-card {
        background: var(--bg-glass);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        transition: all 0.3s var(--ease-smooth);
    }
    
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-glow);
    }
    
    .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .card-detail {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }
    
    .card-label {
        color: var(--text-muted);
    }
    
    .card-value {
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    /* Loading Spinner */
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .results-table {
            font-size: 0.8rem;
        }
        
        .results-table th,
        .results-table td {
            padding: 0.75rem 0.5rem;
        }
        
        .results-cards {
            grid-template-columns: 1fr;
        }
        
        /* Ensure profile image is responsive on mobile */
        .profile-btn img {
            width: 32px;
            height: 32px;
        }
        
        /* Adjust icon sizes for mobile */
        .label-icon {
            width: 14px;
            height: 14px;
        }
        
        .btn-icon {
            width: 18px;
            height: 18px;
        }
        
        .select-all-container {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .select-all-btn,
        .clear-all-btn {
            width: 100%;
        }
        
        /* Form adjustments for mobile */
        .form-row {
            flex-direction: column;
            gap: 0;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
    }
    
    /* Form row adjustments */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: flex;
        align-items: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }
    
    .form-input,
    .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-primary);
        background: var(--bg-glass);
        color: var(--text-primary); /* Ensure text is visible */
        font-size: 1rem;
        transition: all 0.3s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    
    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
    }
    
    .form-select[multiple] {
        height: 200px;
        padding: 0.5rem;
        background: var(--bg-glass);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
        overflow-y: auto;
    }
    
    .form-select[multiple]:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
    }
    
    .form-select[multiple] option {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin: 2px 0;
        background: var(--bg-secondary); /* Set background for options */
        color: var(--text-primary); /* Ensure option text is visible */
    }
    
    .form-select[multiple] option:checked {
        background: var(--gradient-primary);
        color: white;
    }
    
    /* Ensure single select dropdowns have proper text color */
    .form-select:not([multiple]) {
        color: var(--text-primary);
        background: var(--bg-glass);
    }
    
    /* Fix for dropdown arrow color */
    .form-select:not([multiple]) {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    
    /* Ensure option elements have proper contrast */
    option {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    option:checked {
        background: var(--gradient-primary);
        color: white;
    }
    
    /* Button styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius-full);
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s var(--ease-smooth);
        position: relative;
        overflow: hidden;
        white-space: nowrap;
    }
    
    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow-glow);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(14, 165, 233, 0.4);
    }
    
    .btn-xl {
        padding: 1.25rem 2.5rem;
        font-size: 1.125rem;
    }
    
    /* Auth section styling */
    .auth-main {
        min-height: calc(100vh - 80px);
        display: flex;
        align-items: center;
        padding: 2rem 0;
    }
    
    .auth-container {
        display: grid;
        gap: 2rem;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
    }
    
    .auth-form-section {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-xl);
        padding: 2.5rem;
        box-shadow: var(--shadow-lg);
    }
    
    .auth-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .auth-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        background: var(--gradient-text);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .auth-subtitle {
        font-size: 1.125rem;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
    }
    
    .auth-form {
        max-width: 800px;
        margin: 0 auto;
    }
    
    /* Section title */
    .section-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    /* Results container */
    .results-container {
        margin-top: 1rem;
    }
</style>

<!-- JavaScript for College Search -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Populate courses dropdown with all unique courses from dataset
        const courseSelect = document.getElementById('course');
        
        // Read courses from the generated file
        fetch('/static/data/courses.txt')
            .then(response => response.text())
            .then(text => {
                const courses = text.split('\n').filter(course => course.trim() !== '');
                courses.forEach(course => {
                    if (course.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = course.trim();
                        option.textContent = course.trim();
                        courseSelect.appendChild(option);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading courses:', error);
                // Fallback to hardcoded courses if file loading fails
                const fallbackCourses = [
                    "Civil Engineering", "Computer Science and Engineering", "Electrical Engineering", 
                    "Electronics and Telecommunication Engg", "Mechanical Engineering", 
                    "Information Technology", "Chemical Engineering", "Computer Engineering",
                    "Instrumentation Engineering", "Food Technology", "Oil and Paints Technology",
                    "Paper and Pulp Technology", "Petro Chemical Engineering", 
                    "Electrical Engg[Electronics and Power]", "Artificial Intelligence (AI) and Data Science",
                    "Computer Science and Engineering (IoT)", 
                    "Computer Science and Engineering(Artificial Intelligence and Machine Learning)",
                    "Artificial Intelligence and Data Science", "Textile Engineering / Technology",
                    "Computer Science and Information Technology"
                ];
                fallbackCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseSelect.appendChild(option);
                });
            });
        
        // Populate cities dropdown with all unique cities
        const citiesSelect = document.getElementById('cities');
        
        // Read cities from the generated file
        fetch('/static/data/cities.txt')
            .then(response => response.text())
            .then(text => {
                const cities = text.split('\n').filter(city => city.trim() !== '');
                cities.forEach(city => {
                    if (city.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = city.trim();
                        option.textContent = city.trim();
                        citiesSelect.appendChild(option);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading cities:', error);
                // Fallback to hardcoded cities if file loading fails
                const fallbackCities = [
                    "Delhi", "Mumbai", "Bangalore", "Chennai", "Kolkata", "Hyderabad", "Pune", 
                    "Ahmedabad", "Jaipur", "Lucknow", "Kanpur", "Nagpur", "Indore", "Thane", 
                    "Bhopal", "Visakhapatnam", "Patna", "Vadodara", "Ghaziabad", "Ludhiana",
                    "Amravati", "Nashik", "Aurangabad", "Solapur", "Navi Mumbai", "Thiruvananthapuram",
                    "Bhubaneswar", "Coimbatore", "Guwahati", "Chandigarh", "Tiruchirappalli"
                ];
                fallbackCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citiesSelect.appendChild(option);
                });
            });
        
        // Add Select All / Clear All functionality for courses
        const selectAllCoursesBtn = document.getElementById('selectAllCourses');
        const clearAllCoursesBtn = document.getElementById('clearAllCourses');
        
        selectAllCoursesBtn.addEventListener('click', function() {
            for (let i = 0; i < courseSelect.options.length; i++) {
                courseSelect.options[i].selected = true;
            }
        });
        
        clearAllCoursesBtn.addEventListener('click', function() {
            for (let i = 0; i < courseSelect.options.length; i++) {
                courseSelect.options[i].selected = false;
            }
        });
        
        // Add Select All / Clear All functionality for cities
        const selectAllCitiesBtn = document.getElementById('selectAllCities');
        const clearAllCitiesBtn = document.getElementById('clearAllCities');
        
        selectAllCitiesBtn.addEventListener('click', function() {
            for (let i = 0; i < citiesSelect.options.length; i++) {
                citiesSelect.options[i].selected = true;
            }
        });
        
        clearAllCitiesBtn.addEventListener('click', function() {
            for (let i = 0; i < citiesSelect.options.length; i++) {
                citiesSelect.options[i].selected = false;
            }
        });
        
        // Handle form submission
        const searchForm = document.getElementById('collegeSearchForm');
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(searchForm);
            
            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('noResultsMessage').style.display = 'none';
            
            // Disable search button
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.querySelector('.btn-text').textContent = 'Searching...';
            
            // Send AJAX request
            fetch('{% url "college_recommendation:search_colleges" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                
                // Enable search button
                searchBtn.disabled = false;
                searchBtn.querySelector('.btn-text').textContent = 'Search Colleges';
                
                if (data.success && data.colleges.length > 0) {
                    // Display results
                    displayResults(data.colleges);
                    document.getElementById('resultsSection').style.display = 'block';
                } else {
                    // Show no results message
                    document.getElementById('noResultsMessage').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Hide loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                
                // Enable search button
                searchBtn.disabled = false;
                searchBtn.querySelector('.btn-text').textContent = 'Search Colleges';
                
                // Show error message
                alert('An error occurred while searching. Please try again.');
            });
        });
        
        // Function to display results
        function displayResults(colleges) {
            const container = document.getElementById('resultsContainer');
            
            // Create table view with horizontal scrolling container
            let tableHTML = `
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>College Code</th>
                                <th>College Name</th>
                                <th>Course Code</th>
                                <th>Course Name</th>
                                <th>Category</th>
                                <th>Merit Rank</th>
                                <th>Percentile</th>
                                <th>City</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            colleges.forEach(college => {
                tableHTML += `
                    <tr>
                        <td>${college.college_code}</td>
                        <td>${college.college_name}</td>
                        <td>${college.course_code}</td>
                        <td>${college.course_name}</td>
                        <td>${college.category}</td>
                        <td>${college.merit_rank}</td>
                        <td>${college.percentile}</td>
                        <td>${college.city}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }
    });
</script>
{% endblock %}